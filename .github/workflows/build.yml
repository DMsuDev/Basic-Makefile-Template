name: Build & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build-type: [debug, release, relwithdebinfo]
      fail-fast: false # Don't cancel other jobs if one fails, to get full test coverage

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up build environment
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            choco install mingw -y
          elif [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y build-essential --no-install-recommends
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew update
          fi
        shell: bash

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            examples/ImGui/build/
          key: ${{ runner.os }}-build-${{ matrix.build-type }}-${{ hashFiles('examples/ImGui/Makefile', 'examples/ImGui/**/*.cpp', 'examples/ImGui/**/*.h', 'examples/ImGui/**/*.hpp') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.build-type }}-

      - name: Build ImGui example (${{ matrix.build-type }})
        run: |
          cd examples/ImGui
          if [ "$RUNNER_OS" = "macOS" ]; then
            make BUILD_TYPE=${{ matrix.build-type }} CXX=clang++ clean all -j$(nproc 2>/dev/null || echo 4)
          else
            make BUILD_TYPE=${{ matrix.build-type }} clean all -j$(nproc 2>/dev/null || echo 4)
          fi
        shell: bash

      - name: Build ImGui example with analyze
        if: matrix.build-type == 'debug' && runner.os == 'Linux'
        run: |
          cd examples/ImGui
          if [ "$RUNNER_OS" = "macOS" ]; then
            make clean CXX=clang++ analyze
          else
            make clean analyze
          fi
        shell: bash

      - name: Check compilation
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd examples/ImGui
          make BUILD_TYPE=debug WARN_LEVEL=normal clean all 2>&1 | tee build.log
          # Count actual compilation errors (not warnings)
          ERROR_COUNT=$(grep -c "error:" build.log || true)
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "❌ Compilation errors found:"
            grep "error:" build.log
            exit 1
          else
            echo "✅ Build successful (warnings are allowed in CI)"
          fi
        shell: bash

  test-examples:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential --no-install-recommends

      - name: Build all examples
        run: |
          make BUILD_TYPE=release clean all -j$(nproc)

      - name: Verify executable exists
        run: |
          [ -f "examples/ImGui/build/app/ImGuiExample" ] || { echo "Executable not found!"; exit 1; }
          echo "✓ ImGuiExample executable built successfully"