name: Build & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build-type: [debug, release, relwithdebinfo]
      fail-fast: false # Don't cancel other jobs if one fails, to get full test coverage

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up build environment
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            choco install mingw -y
          elif [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y build-essential --no-install-recommends
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install gcc
          fi
        shell: bash

      - name: Build ImGui example (${{ matrix.build-type }})
        run: |
          cd examples/ImGui
          make BUILD_TYPE=${{ matrix.build-type }}
        shell: bash

      - name: Build ImGui example with analyze
        if: matrix.build-type == 'debug' && runner.os == 'Linux'
        run: |
          cd examples/ImGui
          make analyze
        shell: bash

      - name: Check compilation warnings
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd examples/ImGui
          make BUILD_TYPE=debug 2>&1 | tee build.log
          if grep -i "error:" build.log; then
            exit 1
          fi
        shell: bash

  test-examples:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential --no-install-recommends

      - name: Build all examples
        run: |
          make

      - name: Verify executable exists
        run: |
          [ -f "examples/ImGui/build/app/ImGuiExample" ] || exit 1
          echo "âœ“ ImGui executable built successfully"

  code-quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \ 
            build-essential cppcheck clang-tidy

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --suppress=missingIncludeSystem \
            examples/donut-basic/src/ \
            examples/*/

      - name: Run clang-tidy
        run: |
          clang-tidy examples/*/src/*.cpp -- -Iexamples/*/include
