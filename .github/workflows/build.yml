name: Build & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build-type: [debug, release, relwithdebinfo]
      fail-fast: false # Don't cancel other jobs if one fails, to get full test coverage

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up build environment
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            choco install mingw -y
          elif [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y build-essential --no-install-recommends
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew update
          fi
        shell: bash

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            examples/task-manager/build/
            examples/donut-basic/build/
          key: ${{ runner.os }}-build-${{ matrix.build-type }}-${{ hashFiles('examples/task-manager/makefile', 'examples/task-manager/**/*.cpp', 'examples/donut-basic/makefile', 'examples/donut-basic/**/*.cpp') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.build-type }}-

      - name: Build task-manager example (${{ matrix.build-type }})
        run: |
          cd examples/task-manager
          if [ "$RUNNER_OS" = "macOS" ]; then
            make BUILD_TYPE=${{ matrix.build-type }} CXX=clang++ clean all -j$(nproc 2>/dev/null || echo 4)
          else
            make BUILD_TYPE=${{ matrix.build-type }} clean all -j$(nproc 2>/dev/null || echo 4)
          fi
        shell: bash

      - name: Build donut-basic example (${{ matrix.build-type }})
        run: |
          cd examples/donut-basic
          if [ "$RUNNER_OS" = "macOS" ]; then
            make BUILD_TYPE=${{ matrix.build-type }} CXX=clang++ clean all -j$(nproc 2>/dev/null || echo 4)
          else
            make BUILD_TYPE=${{ matrix.build-type }} clean all -j$(nproc 2>/dev/null || echo 4)
          fi
        shell: bash
      
      - name: Generate assembly and disassembly
        run: |
          cd examples/task-manager
          if [ "$RUNNER_OS" = "macOS" ]; then
            make CXX=clang++ asm disassemble || true
          else
            make asm disassemble || true
          fi
        shell: bash

      - name: Build task-manager with static analysis
        if: matrix.build-type == 'debug' && runner.os == 'Linux'
        run: |
          cd examples/task-manager
          if [ "$RUNNER_OS" = "macOS" ]; then
            make clean CXX=clang++ analyze
          else
            make clean analyze
          fi
        shell: bash

      - name: Check compilation
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd examples/task-manager
          make BUILD_TYPE=debug WARN_LEVEL=normal clean all 2>&1 | tee build.log
          # Count actual compilation errors (not warnings)
          ERROR_COUNT=$(grep -c "error:" build.log || true)
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "❌ Compilation errors found:"
            grep "error:" build.log
            exit 1
          else
            echo "✅ Build successful (warnings are allowed in CI)"
          fi
        shell: bash

  test-examples:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential --no-install-recommends

      - name: Build task-manager example
        run: |
          cd examples/task-manager
          make BUILD_TYPE=release clean all asm disassemble -j$(nproc)

      - name: Build donut-basic example
        run: |
          cd examples/donut-basic
          make BUILD_TYPE=release clean all -j$(nproc)

      - name: Verify executables
        run: |
          [ -f "examples/task-manager/build/app/tm" ] || { echo "task-manager executable not found!"; exit 1; }
          echo "✓ task-manager executable built successfully"
          [ -f "examples/donut-basic/build/app/donut" ] || { echo "donut-basic executable not found!"; exit 1; }
          echo "✓ donut-basic executable built successfully"